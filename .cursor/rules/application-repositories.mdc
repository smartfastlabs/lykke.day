---
globs: backend/planned/application/repositories/**/*.py
alwaysApply: false
---

# Application Repository Protocols Rules

Repository protocols define the interface for data access. They are defined in `application/repositories/`.

---

## Protocol Definition

Repository protocols extend base protocols:

```python
from planned.application.repositories.base import (
    ReadOnlyRepositoryProtocol,
    ReadWriteRepositoryProtocol,
)
from planned.domain.entities import TaskEntity
from planned.domain import value_objects

class TaskRepositoryReadOnlyProtocol(ReadOnlyRepositoryProtocol[TaskEntity]):
    """Read-only protocol for task repositories."""
    Query = value_objects.TaskQuery  # Optional: specify query type

class TaskRepositoryReadWriteProtocol(ReadWriteRepositoryProtocol[TaskEntity]):
    """Read-write protocol for task repositories."""
    Query = value_objects.TaskQuery  # Optional: specify query type
```

---

## Base Protocols

Base protocols define standard operations:

**ReadOnlyRepositoryProtocol:**
- `get(key: UUID) -> T` - Get entity by ID
- `all() -> list[T]` - Get all entities
- `search_query(query: object) -> list[T]` - Search entities

**ReadWriteRepositoryProtocol:**
- All read operations from `ReadOnlyRepositoryProtocol`
- `put(obj: T) -> T` - Save or update entity
- `delete(key: UUID | T) -> None` - Delete entity
- `insert_many(*objs: T) -> list[T]` - Insert multiple entities
- `delete_many(query: object) -> None` - Delete entities matching query
- `apply_updates(key: UUID, **updates: Any) -> T` - Apply partial updates

---

## Key Rules for Protocols

1. **Use Protocol type** - Use Python `Protocol` for interface definitions
2. **Type parameter** - Protocols are generic with entity type parameter
3. **Optional Query type** - Can specify `Query` class variable for query type hints
4. **Separate read/write** - Separate read-only and read-write protocols
5. **No implementation** - Protocols define interface only, no implementation

---

## Gotchas

### 1. Protocols vs Implementations

**Issue:** Always use protocols, never concrete implementations in handlers.

```python
# Wrong
def __init__(self, task_repo: TaskRepository) -> None:  # Concrete implementation

# Right
def __init__(self, task_repo: TaskRepositoryProtocol) -> None:  # Protocol
```

---

## Common Patterns

### Repository Protocol Pattern

```python
class MyEntityRepositoryReadOnlyProtocol(ReadOnlyRepositoryProtocol[MyEntity]):
    """Read-only protocol for MyEntity repositories."""
    Query = MyEntityQuery

class MyEntityRepositoryReadWriteProtocol(ReadWriteRepositoryProtocol[MyEntity]):
    """Read-write protocol for MyEntity repositories."""
    Query = MyEntityQuery
```
