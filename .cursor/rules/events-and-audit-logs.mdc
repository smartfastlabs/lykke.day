---
globs: backend/lykke/**/*.py
alwaysApply: true
---

# Event System & Change Streaming

This guide reflects the current event model in the codebase.

## What Exists Now

### 1) DomainEvent (in-memory, transactional)

- Domain events are dataclasses extending `DomainEvent` (`domain/events/base.py`)
- Events are emitted by entities and collected by `SqlAlchemyUnitOfWork`
- Handlers run **before commit** via `send_domain_events()`
- All events include `user_id` and `occurred_at`

### 2) Redis PubSub domain-events channel (post-commit)

- After a successful commit, UoW publishes serialized domain events to:
  - `domain-events:{user_id}` channel
  - `latest-domain-event` user stream (maxlen 1)
- This happens in `SqlAlchemyUnitOfWork._broadcast_domain_events_to_redis`

### 3) Redis entity-changes stream (post-commit incremental sync)

- UoW emits entity change records to `entity-changes` stream per user
- Used for websocket incremental sync and "since stream id" flows
- Includes: `change_type`, `entity_type`, `entity_id`, `entity_date`, `entity_patch`, timestamps

## Important: Removed Concepts

These are no longer part of the architecture:

- `AuditLogEntity`
- `audit_logs` table
- `AuditLogRepository*` protocols/implementations
- `AuditLogQuery` and audit-log-specific utility modules
- `AuditableDomainEvent` mixin

Do not introduce new dependencies on removed audit log primitives.

## Event Flow

1. Entity method emits `DomainEvent`
2. Command adds entity to UoW (`uow.add/create/delete`)
3. UoW processes entities and collects events
4. UoW dispatches events to handlers (**before commit**)
5. DB transaction commits
6. UoW publishes:
   - domain events (PubSub + latest-domain-event stream)
   - entity changes (`entity-changes` stream)

## Handler Rules

- Handlers extend `DomainEventHandler`
- Handler instances are created per user from `event.user_id`
- Handler constructor uses:
  - `user: UserEntity`
  - `repository_factory: ReadOnlyRepositoryFactoryProtocol`
  - optional `uow_factory: UnitOfWorkFactory`
- If handler opens UoW, use `self._uow_factory.create(self.user)`

## WebSocket Guidance

- WebSocket sync should use entity change stream + domain event id cursors
- Prefer `last_change_stream_id` / `latest_domain_event_id` style cursors
- Do not assume an audit log record exists for each domain event

## Testing Guidance

- Test that events are dispatched before commit side effects are finalized
- Test post-commit publishing behavior does not rollback transaction on publish failure
- Test incremental sync using entity change stream ids (not audit log timestamps)

## Quick Do / Don't

- **Do:** model business occurrences as `DomainEvent`
- **Do:** keep handler work transactional and fast
- **Do:** use Redis streams/channels for post-commit real-time sync
- **Don't:** query audit logs for business logic
- **Don't:** add back audit-log-specific repositories/entities unless architecture changes
