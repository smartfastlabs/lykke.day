---
globs: *.py
alwaysApply: true
---

# Python Development Guide

## Running Commands

**Always use Poetry to run Python commands:**

```bash
# Correct
poetry run pytest tests/unit
poetry run alembic upgrade head
poetry run mypy planned
poetry run uvicorn planned.app:app --reload

# Incorrect - will use wrong environment
pytest tests/unit
python -m alembic upgrade head
```

## Quick Commands

```bash
# Testing
make test                           # Run all tests
make test-target TARGET=test_name   # Run tests matching name
make typecheck                      # Run mypy
make check                          # Run typecheck + tests

# Development
make serve                          # Start dev server
make migrate-dev                    # Apply migrations
make migrate-create MSG='message'   # Create migration
```

## Code Style

- Use type hints everywhere (mypy strict mode is enabled)
- Use `async/await` for all I/O operations
- Prefer Pydantic models for data classes
- Use `UUID` for entity IDs (auto-generated via `default_factory=uuid4`)

## Imports

```python
# Standard library first
from datetime import UTC, datetime
from uuid import UUID

# Third-party second
from pydantic import Field
from sqlalchemy import select

# Local imports last, using absolute paths
from planned.domain.entities import Task
from planned.application.repositories import TaskRepositoryProtocol
```

## Testing

- Mark async tests with `@pytest.mark.asyncio`
- Use `dobles` for mocking (not unittest.mock for protocols)
- Use `freezegun` for time-dependent tests
- Test fixtures go in `tests/conftest.py` or layer-specific conftest

## Type Checking

The project uses strict mypy settings. Key rules:

- All function parameters must have type hints
- All return types must be specified
- No implicit `Any` types
- Use `cast()` when protocol compatibility requires it
