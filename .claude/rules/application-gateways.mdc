---
globs: backend/lykke/application/gateways/**/*.py
alwaysApply: false
---

# Application Gateway Protocols Rules

Gateway protocols define the interface for external services. They are defined in `application/gateways/`.

---

## Protocol Definition

Gateway protocols use Python `Protocol`:

```python
from typing import Protocol

from lykke.domain.entities import CalendarEntity, CalendarEntryEntity
from lykke.infrastructure import data_objects


class GoogleCalendarGatewayProtocol(Protocol):
    """Protocol for Google Calendar gateway."""
    
    async def load_calendar_events(
        self,
        calendar: CalendarEntity,
        lookback: datetime,
        token: data_objects.AuthToken,
    ) -> list[CalendarEntryEntity]:
        """Load calendar entries from Google Calendar."""
        ...
    
    def get_flow(self, flow_name: str) -> Flow:
        """Get OAuth flow for Google authentication."""
        ...
```

---

## Key Rules for Gateways

1. **Use Protocol type** - Use Python `Protocol` for interface definitions
2. **Return domain objects** - Methods return domain entities or value objects
3. **Accept domain objects** - Methods accept domain entities or value objects
4. **No implementation** - Protocols define interface only
5. **Can use infrastructure types** - Can use data objects for external APIs (e.g., `AuthToken`)

---

## Gateway Types

### LLM Gateway Protocol

```python
from lykke.domain.value_objects.ai_chat import LLMRequestOptions

class LLMGatewayProtocol(Protocol):
    """Protocol for LLM service gateway."""
    
    async def chat(
        self,
        prompt: str,
        system_prompt: str | None = None,
        options: LLMRequestOptions | None = None,
    ) -> str:
        """Send a chat request to the LLM."""
        ...
```

### PubSub Gateway Protocol

```python
class PubSubGatewayProtocol(Protocol):
    """Protocol for pub/sub messaging."""
    
    async def publish(self, channel: str, message: str) -> None:
        """Publish a message to a channel."""
        ...
    
    def subscribe_to_user_channel(
        self,
        user_id: UUID,
        channel_type: str,
    ) -> AsyncContextManager[PubSubSubscription]:
        """Subscribe to a user's channel."""
        ...
```

### Web Push Gateway Protocol

```python
class WebPushGatewayProtocol(Protocol):
    """Protocol for web push notifications."""
    
    async def send_notification(
        self,
        subscription: PushSubscriptionEntity,
        title: str,
        body: str,
    ) -> bool:
        """Send a push notification."""
        ...
```

---

## Common Patterns

### Gateway Protocol Pattern

```python
class MyExternalGatewayProtocol(Protocol):
    """Protocol for MyExternal service gateway."""
    
    async def fetch_data(self, params: Params) -> list[Entity]:
        """Fetch data from external service."""
        ...
    
    async def send_data(self, entity: Entity) -> bool:
        """Send data to external service."""
        ...
```

### Gateway Factory Protocol

```python
class LLMGatewayFactory(Protocol):
    """Factory for creating LLM gateway instances."""
    
    def create(self, provider: str = "anthropic") -> LLMGatewayProtocol:
        """Create an LLM gateway for the specified provider."""
        ...
```
